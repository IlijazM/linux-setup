---
- name: Server Setup
  hosts: all
  become: yes
  vars:
    root_password_hash: "$1$7QHVBz$wJFZSvYe2nnexnh4hr/BX/"

  tasks:
    - name: Step 1 - Update and upgrade packages
      apt:
        update_cache: yes
        upgrade: dist

    - name: Install useful packages
      apt:
        name:
          - git
          - curl
          - wget
          - net-tools
          - nano
          - sudo
        state: present

    - name: Step 2 - Set root password if yes_to_all is true
      user:
        name: root
        password: "{{ root_password_hash }}"

    - name: Add user 'ich'
      user:
        name: ich
        groups: sudo
        append: yes
        create_home: yes
        state: present

    - name: Remove password for user 'ich'
      command: passwd -d ich

    - name: Ensure .ssh directory exists for root
      file:
        path: /root/.ssh
        state: directory
        owner: root
        group: root
        mode: "0700"

    - name: Step 3 - Generate SSH key for root
      openssh_keypair:
        path: /root/.ssh/id_ed25519
        type: ed25519
        comment: "mehmedovic.ilijaz@gmail.com"
        force: no

    - name: Ensure .ssh directory exists for ich
      file:
        path: /home/ich/.ssh
        state: directory
        owner: ich
        group: ich
        mode: "0700"

    - name: Add authorized SSH keys for ich
      copy:
        dest: /home/ich/.ssh/authorized_keys
        content: |
          ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIFk1Do6byK1ypZC5KuDR/dIqqPooycR7BqkGMghP/flD ilijaz@fedora.fritz.box
          ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQDaBwDMkOF7SHfCrHbhfK9+6QSBbiEWnmXXGsh/zKOfoc6n5GvKPGYvGYy+yW7UNKYVKapgwgYxKJgTJ5/PisnSvuCNMzN3SRT47W6RNMaY3EcIUF5chJAsR/J3dA46F2LZJTZOZH+jD3POclIxq2bkEH5WVObv5SxqW3HTj2bck1JXAYlZqCAulV0brYnFWqMMiT3JQTENRY27EZAB6ctDk7siS/41af8XuC9ais7zQWKU1jUwm/BwRBhfN2/OpSW+zO66SdKcGCMt0e/eQtvcN7yEtam1RRk9IH93lE8V1iujCxk8H4/K7JhAG1wLT1KrlzHj12gfhY+beXysHUHRnNUhDjJ4w4T8sVSRwpvjWPCQrtRngqzMPpNoAH61+TCb315SC+rLYBDXora+pf02PLrYHA/NvuVl0ydaCgE2wgQ21QuOP81oD8joppCBfP0u0T5QLRMXZGp5eI6+NcOIsnSUP1bpBusCiu8mg4DQhMwGsEZxwLwOALxkp7NYtXU= azuread\ilijazmehmedovic@RIMIT020
          ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIGf+R+0mu74RfSnDS7SmeqylPJaXqVAGA47tK758szm9 mehmedovic.ilijaz@gmail.com
          ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIBj/CNNH44dlEU8Uu6U11SRG0op2mnP4ti/qb4vkzDO7 ilijazm@ilijaz
        owner: ich
        group: ich
        mode: "0600"

    - name: Change SSH port to 4242
      lineinfile:
        path: /etc/ssh/sshd_config
        regexp: "^#?Port "
        line: "Port 4242"

    - name: Disallow root login
      lineinfile:
        path: /etc/ssh/sshd_config
        regexp: "^PermitRootLogin"
        line: "PermitRootLogin no"

    - name: Restart SSH service (works in container)
      service:
        name: ssh
        state: restarted
        use: service
